<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webpage to PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.js"></script>
</head>
<body>
    <button id="generate-pdf">Generate PDF</button>

    <script>
        document.getElementById("generate-pdf").addEventListener("click", async function () {
            // Fetch the HTML template from the remote URL
            const templateUrl = 'https://github.com/Mateusbertolini/proof_of_concept/raw/main/src/layout_imprimir.html';
            const templateResponse = await fetch(templateUrl);
            const templateHtml = await templateResponse.text();

            // Get the element containing the content you want to capture (e.g., the entire webpage)
            const elementToCapture = document.body;

            // Use html2canvas to capture the content as an image
            const canvas = await html2canvas(elementToCapture);

            // Create a new PDF document
            const pdfDoc = await PDFLib.PDFDocument.create();

            // Add a page to the PDF document
            const page = pdfDoc.addPage([canvas.width, canvas.height]);
            const { width, height } = page.getSize();

            // Embed the captured image on the page
            const image = await pdfDoc.embedPng(canvas.toDataURL('image/png'));
            page.drawImage(image, {
                x: 0,
                y: 0,
                width: width,
                height: height,
            });

            // Add a footer with the page count
            const pageCount = pdfDoc.getPageCount();
            for (let i = 0; i < pageCount; i++) {
                const currentPage = pdfDoc.getPage(i);
                currentPage.drawText(`Page ${i + 1} of ${pageCount}`, {
                    x: 50,
                    y: 20,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0),
                });
            }

            // Create a PDF element for the template HTML
            const templatePdfBytes = await pdfDoc.embedPdf(templateHtml);

            // Add the template PDF as a background
            page.drawPage(templatePdfBytes, {
                x: 0,
                y: 0,
                width: width,
                height: height,
            });

            // Serialize the final PDF
            const pdfBytes = await pdfDoc.save();

            // Create a blob from the PDF bytes
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });

            // Create a download link and trigger the download
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'webpage.pdf';
            a.click();
        });
    </script>
</body>
</html>
